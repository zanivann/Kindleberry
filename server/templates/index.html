<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>âš™ï¸ {{ tr.ui_title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --primary: #2c3e50;
            --accent: #3498db;
            --text: #333;
            --border: #dcdde1;
        }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 500px; margin: auto; }
        
        .card { 
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
        }

        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; text-transform: uppercase; }
        .badge-run { background: #e8f5e9; color: #27ae60; border: 1px solid #27ae60; }
        .badge-stop { background: #ffebee; color: #e74c3c; border: 1px solid #e74c3c; }

        .btn-toggle { 
            padding: 12px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; color: white; width: 100%; font-weight: 600; 
        }

        label { display: block; margin: 15px 0 5px 0; font-weight: 600; font-size: 0.85em; color: #555; }

        input[type="text"], 
        input[type="number"], 
        select { 
            width: 100%; 
            height: 45px; 
            padding: 0 12px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 15px;
            background-color: #fff;
            display: block;
        }

        .section-title { 
            background: #f8f9fa; padding: 8px 12px; margin: 25px -25px 15px -25px; font-size: 0.75em; color: #7f8c8d; font-weight: bold; text-transform: uppercase; border-left: 4px solid var(--accent);
        }

        .row-group { display: flex; gap: 15px; }
        .row-group > div { flex: 1; }

        /* BOTÃƒO DE BUSCA DE COORDENADAS */
        .search-group { display: flex; gap: 10px; align-items: flex-end; }
        .btn-search {
            height: 45px;
            padding: 0 15px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }
        .btn-search:hover { background: #2980b9; }

        .btn-save { 
            background: var(--primary); color: #fff; padding: 14px; width: 100%; border: none; cursor: pointer; border-radius: 8px; font-size: 16px; font-weight: bold; margin-top: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="card">
            <div class="status-header">
                <h3>âš¡ {{ tr.ui_control or 'Sistema' }}</h3>
                <span class="badge {{ 'badge-run' if dash_active else 'badge-stop' }}">
                    {{ tr.ui_status_run if dash_active else tr.ui_status_stop }}
                </span>
            </div>
            <form action="/toggle_status" method="POST">
                <button type="submit" class="btn-toggle" style="background-color: {{ '#e74c3c' if dash_active else '#27ae60' }};">
                    {{ tr.ui_btn_stop if dash_active else tr.ui_btn_start }}
                </button>
            </form>
        </div>

        <div class="card">
            <h3>ğŸ› ï¸ {{ tr.ui_title }}</h3>
            <form action="/update" method="POST">
                
                <label>ğŸŒ {{ tr.ui_language }}</label>
                <select name="language">
                    <option value="pt_BR" {% if config.language == 'pt_BR' %}selected{% endif %}>PortuguÃªs (BR)</option>
                    <option value="en_US" {% if config.language == 'en_US' %}selected{% endif %}>English (US)</option>
                </select>

                <label>ğŸ’¡ Brilho Real do Kindle (0-24)</label>
                <div class="row-group" style="align-items: center; gap: 15px;">
                    <input type="range" name="brightness" min="0" max="24" 
                           value="{{ config.brightness }}" 
                           oninput="this.nextElementSibling.innerText = this.value"
                           style="flex: 1; height: 15px; cursor: pointer;">
                    
                    <output style="font-weight: bold; font-size: 1.2em; min-width: 30px; text-align: right;">
                        {{ config.brightness }}
                    </output>
                </div>

                <div class="section-title">ğŸ“ {{ tr.ui_weather_source or 'LocalizaÃ§Ã£o' }}</div>

                <label>â˜ï¸ {{ tr.ui_weather_source }}</label>
                <select name="weather_source">
                    <option value="online" {% if config.weather_source == 'online' %}selected{% endif %}>ğŸŒ {{ tr.ui_opt_online }}</option>
                    <option value="sensor" {% if config.weather_source == 'sensor' %}selected{% endif %}>ğŸŒ¡ï¸ {{ tr.ui_opt_sensor }}</option>
                </select>

                <label>ğŸ™ï¸ {{ tr.ui_city }}</label>
                <div class="search-group">
                    <input type="text" id="city_input" name="city_name" value="{{ config.city_name }}" placeholder="Digite a cidade...">
                    <button type="button" class="btn-search" onclick="lookupCoords()">ğŸ“ Buscar</button>
                </div>

                <div class="row-group">
                    <div>
                        <label>ğŸ§­ Lat</label>
                        <input type="text" id="lat_field" name="lat" value="{{ config.lat }}">
                    </div>
                    <div>
                        <label>ğŸ§­ Lon</label>
                        <input type="text" id="lon_field" name="lon" value="{{ config.lon }}">
                    </div>
                </div>

                <div class="section-title">ğŸ“º {{ tr.ui_display or 'AparÃªncia' }}</div>

                <label>ğŸ•’ {{ tr.ui_timezone }}</label>
                <input type="text" name="timezone" value="{{ config.timezone }}">

                <div class="row-group">
                    <div>
                        <label>ğŸŒ— {{ tr.ui_theme }}</label>
                        <select name="theme_mode">
                            <option value="auto" {% if config.theme_mode == 'auto' %}selected{% endif %}>âœ¨ AutomÃ¡tico</option>
                            <option value="light" {% if config.theme_mode == 'light' %}selected{% endif %}>â˜€ï¸ Claro</option>
                            <option value="dark" {% if config.theme_mode == 'dark' %}selected{% endif %}>ğŸŒ‘ Escuro</option>
                        </select>
                    </div>
                    <div>
                        <label>ğŸ“ {{ tr.ui_font_size }}</label>
                        <input type="number" name="font_size" value="{{ config.font_size }}">
                    </div>
                </div>

                <label>ğŸ”„ {{ tr.ui_rotation }}</label>
                <select name="rotation">
                    <option value="0" {% if config.rotation == 0 %}selected{% endif %}>ğŸ“± Retrato</option>
                    <option value="1" {% if config.rotation == 1 %}selected{% endif %}>ğŸ“Ÿ Paisagem</option>
                    <option value="2" {% if config.rotation == 2 %}selected{% endif %}>ğŸ™ƒ Invertido</option>
                </select>

                <button type="submit" class="btn-save">ğŸ’¾ {{ tr.ui_save }}</button>
            </form>
        </div>
    </div>

    <script>
        async function lookupCoords() {
            const city = document.getElementById('city_input').value;
            if (!city) {
                alert("Por favor, digite o nome de uma cidade.");
                return;
            }

            const btn = document.querySelector('.btn-search');
            btn.innerText = "âŒ›...";

            try {
                // Busca no OpenStreetMap (Nominatim)
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    document.getElementById('lat_field').value = parseFloat(data[0].lat).toFixed(4);
                    document.getElementById('lon_field').value = parseFloat(data[0].lon).toFixed(4);
                    btn.innerText = "âœ… OK";
                    setTimeout(() => btn.innerText = "ğŸ“ Buscar", 2000);
                } else {
                    alert("Cidade nÃ£o encontrada.");
                    btn.innerText = "ğŸ“ Buscar";
                }
            } catch (error) {
                alert("Erro ao buscar coordenadas.");
                btn.innerText = "ğŸ“ Buscar";
            }
        }
    </script>

</body>
</html>